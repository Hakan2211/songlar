// schema.prisma

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified Boolean   @default(false)

  // RBAC
  role String @default("user") // "admin", "user"

  // Auth
  accounts Account[]
  sessions Session[]

  // Billing
  stripeCustomerId      String?
  subscriptionStatus    String? // "active", "canceled", "past_due", "none"
  subscriptionTier      String? // "free", "starter", "pro"
  subscriptionPeriodEnd DateTime? // When the current billing period ends
  cancelAtPeriodEnd     Boolean   @default(false) // Whether subscription is set to cancel at period end

  // Subscription audit log
  subscriptionEvents SubscriptionEvent[]

  // Onboarding (optional - for multi-step onboarding flows)
  onboardingComplete Boolean @default(false)

  // ====================================================================================
  // Platform Access (one-time payment for lifetime access)
  // ====================================================================================
  hasPlatformAccess       Boolean   @default(false) // Set true after one-time payment
  platformPurchaseDate    DateTime?                  // When they purchased platform access
  platformStripePaymentId String?                    // Stripe payment_intent ID for reference

  // ====================================================================================
  // BYOK - Bring Your Own Key (API keys encrypted with AES-256-GCM)
  // ====================================================================================
  
  // fal.ai API key (for ElevenLabs Music & MiniMax v2)
  falApiKey        String?   // Encrypted API key
  falApiKeyLastFour String?  // Last 4 chars for display (e.g., "...xxxx")
  falApiKeyAddedAt DateTime? // When the key was added/updated

  // MiniMax direct API key (for Music 2.5)
  minimaxApiKey        String?   // Encrypted API key
  minimaxApiKeyLastFour String?  // Last 4 chars for display
  minimaxApiKeyAddedAt DateTime? // When the key was added/updated

  // Bunny.net CDN (for audio storage)
  bunnyApiKey         String?   // Encrypted Storage API key
  bunnyApiKeyLastFour String?   // Last 4 chars for display
  bunnyApiKeyAddedAt  DateTime? // When the key was added/updated
  bunnyStorageZone    String?   // Storage Zone name (e.g., "my-music")
  bunnyPullZone       String?   // Pull Zone hostname (e.g., "my-music")

  // ====================================================================================
  // Replicate API key (for voice conversion)
  // ====================================================================================
  replicateApiKey        String?   // Encrypted API key
  replicateApiKeyLastFour String?  // Last 4 chars for display
  replicateApiKeyAddedAt DateTime? // When the key was added/updated

  // ====================================================================================
  // Music Generation Relations
  // ====================================================================================
  musicGenerations MusicGeneration[]

  // ====================================================================================
  // Voice Cloning & Conversion Relations
  // ====================================================================================
  voiceClones      VoiceClone[]
  voiceConversions VoiceConversion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("account")
}

// For Magic Links / Email Verification
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

// ====================================================================================
// Subscription Event Audit Log
// ====================================================================================

model SubscriptionEvent {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Event type: subscribed, upgraded, downgraded, canceled, reactivated, payment_failed, payment_succeeded
  event String

  // Tier changes (for upgrades/downgrades)
  fromTier String? // "free", "starter", "pro"
  toTier   String? // "free", "starter", "pro"

  // Additional metadata (JSON string)
  metadata String?

  // Stripe-related IDs for reference
  stripeEventId        String?
  stripeSubscriptionId String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([event])
  @@index([createdAt])
  @@map("subscription_event")
}

// ====================================================================================
// Music Generation - Stores history of AI music generations
// ====================================================================================

model MusicGeneration {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Provider info
  provider String // "elevenlabs", "minimax-v2", "minimax-v2.5"
  model    String? // Specific model variant if applicable

  // Input parameters
  prompt       String  // Style/mood description
  lyrics       String? // For MiniMax models (with [verse], [chorus] tags)
  durationMs   Int?    // Requested duration in milliseconds
  outputFormat String? // "mp3_44100_128", etc.
  settings     String? // JSON - Additional model-specific settings

  // Output
  audioUrl        String?              // Final audio URL (CDN or temp)
  originalAudioUrl String?             // Original fal.ai temp URL (before CDN upload)
  audioStored     Boolean @default(false) // Whether audio is persisted to CDN
  audioDurationMs Int?                 // Actual duration of generated audio
  
  // Job status
  status String @default("pending") // "pending", "processing", "completed", "failed"
  error  String? // Error message if failed

  // External job tracking (fal.ai queue or MiniMax)
  requestId   String? // External provider request ID
  statusUrl   String? // URL to poll for status
  responseUrl String? // URL to fetch result
  cancelUrl   String? // URL to cancel job

  // Progress (0-100)
  progress Int @default(0)

  // Metadata
  title      String?              // User-provided or auto-generated title
  isFavorite Boolean @default(false) // Whether track is favorited

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Voice conversions derived from this track
  voiceConversions VoiceConversion[]

  @@index([userId])
  @@index([status])
  @@index([provider])
  @@index([createdAt])
  @@map("music_generation")
}

// ====================================================================================
// Voice Clone - Stores user's cloned voices
// ====================================================================================

model VoiceClone {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Voice identity
  name        String  // User-given name for the voice
  description String? // Optional description

  // Provider info
  provider String // "minimax" | "qwen"

  // MiniMax-specific (returns a voice ID for TTS)
  minimaxVoiceId String? // custom_voice_id from MiniMax voice clone API

  // Qwen-specific (returns a speaker embedding file)
  speakerEmbeddingUrl String? // URL to .safetensors file
  referenceText       String? // Optional reference text for better quality

  // Source audio used for cloning
  sourceAudioUrl    String  // Original training audio URL
  sourceAudioStored Boolean @default(false) // Whether stored on CDN

  // Preview audio (optional TTS preview generated during cloning)
  previewAudioUrl String?

  // RVC Training (for singing voice conversion)
  rvcModelUrl    String? // Trained RVC model .zip URL (from replicate/train-rvc-model)
  rvcModelStatus String? // "training", "ready", "failed" (null = not trained)
  rvcRequestId   String? // Replicate prediction ID for RVC training
  rvcError       String? // Error from RVC training

  // Job status
  status    String  @default("pending") // "pending", "processing", "ready", "failed"
  error     String? // Error message if failed
  requestId String? // External provider request ID

  // Relations
  voiceConversions VoiceConversion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("voice_clone")
}

// ====================================================================================
// Voice Conversion - Stores voice conversion jobs
// ====================================================================================

model VoiceConversion {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Provider info
  provider String // "amphion-svc" | "rvc-v2"

  // Source audio (from completed music generation or voice clone)
  sourceAudioUrl     String           // Audio URL to convert
  sourceType         String           // "generation" | "voice-clone"
  sourceGenerationId String?          // Link to MusicGeneration
  sourceGeneration   MusicGeneration? @relation(fields: [sourceGenerationId], references: [id])
  sourceVoiceCloneId String?          // Link to VoiceClone (when using trained RVC model)
  sourceVoiceClone   VoiceClone?      @relation(fields: [sourceVoiceCloneId], references: [id])

  // Target voice settings
  // For Amphion SVC: preset singer name
  targetSinger String? // "Adele", "Taylor Swift", etc.

  // For RVC v2: custom model
  rvcModelUrl  String? // HuggingFace RVC model URL
  rvcModelName String? // Display name for the model

  // Conversion settings
  pitchShift   Int?   // Semitones (-12 to 12)
  indexRate    Float? // RVC index rate (0-1)
  filterRadius Int?   // RVC filter radius

  // Output
  outputAudioUrl    String? // Converted audio URL
  outputAudioStored Boolean @default(false) // Whether stored on CDN
  audioDurationMs   Int?    // Duration of converted audio

  // Job status
  status    String  @default("pending") // "pending", "processing", "completed", "failed"
  error     String? // Error message if failed
  requestId String? // Replicate prediction ID
  progress  Int     @default(0) // Progress percentage (0-100)

  // Metadata
  title String? // User-provided or auto-generated title

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([sourceGenerationId])
  @@index([sourceVoiceCloneId])
  @@map("voice_conversion")
}
